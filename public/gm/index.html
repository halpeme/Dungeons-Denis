<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>GM Controller - Dungeons & Denis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/gm/gm.css?v=2">
</head>

<body class="bg-gray-900 text-white">
  <!-- Connection Status Bar -->
  <div id="status-bar" class="fixed top-0 left-0 right-0 bg-gray-800 p-2 flex justify-between items-center z-50 h-10">
    <span class="text-amber-400 font-bold">Dungeons & Denis</span>
    <div id="connection-status" class="flex items-center gap-2">
      <span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse" id="status-dot"></span>
      <span id="status-text" class="text-sm">Connecting...</span>
      <button id="retry-btn" class="hidden ml-2 px-2 py-1 text-xs bg-amber-600 hover:bg-amber-500 rounded font-bold">
        Retry Now
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <main class="h-full w-full pt-10 overflow-hidden">
    <!-- Session Panel (shown when no session) -->
    <div id="session-panel" class="p-4 h-full overflow-y-auto">
      <div class="max-w-md mx-auto text-center">
        <h1 class="text-2xl font-bold mb-6">Game Master</h1>

        <div id="create-session-panel">
          <button id="create-session-btn"
            class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-4 px-8 rounded-lg text-xl transition-colors">
            Create New Session
          </button>

          <div class="mt-6 text-gray-400 text-sm">
            <p>Or reconnect to existing session:</p>
            <button id="reconnect-btn" class="mt-2 text-amber-400 underline">Reconnect</button>
          </div>
        </div>

        <div id="join-code-panel" class="hidden">
          <div class="bg-gray-800 rounded-lg p-4 mb-4">
            <p class="text-gray-400 text-sm mb-1">Join Code</p>
            <div id="join-code" class="text-5xl font-mono font-bold text-amber-400 tracking-widest mb-2"></div>
            <button id="copy-code-btn" class="text-sm text-amber-400 underline">Copy Code</button>
          </div>

          <div class="bg-gray-800 rounded-lg p-4 mb-4">
            <p class="text-gray-400 text-sm mb-2">Open this link on the TV/monitor:</p>
            <div class="flex gap-2">
              <input type="text" id="session-table-link" readonly
                class="flex-1 bg-gray-700 text-gray-300 p-2 rounded text-sm font-mono">
              <button id="copy-session-link-btn"
                class="bg-amber-600 hover:bg-amber-500 px-3 py-2 rounded text-sm font-bold">
                Copy
              </button>
            </div>
          </div>

          <div id="table-status" class="p-4 bg-gray-800 rounded-lg">
            <span class="text-gray-400">Table Display:</span>
            <span id="table-connected" class="ml-2 text-red-400">Not Connected</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Control Panel (shown when session active) -->
    <div id="control-panel" class="hidden p-1 h-full overflow-hidden">
      <!-- Tab Content -->
      <div id="tab-content" class="bg-gray-800 rounded-lg p-1">
        <!-- Map Tab - Image-based Fog of War -->
        <div id="tab-map" class="tab-panel h-full">
          <!-- Upload Section (shown when no image) -->
          <div id="map-upload-section" class="h-full overflow-y-auto">
            <h3 class="font-bold mb-3">Map Image</h3>
            <input type="file" id="map-image-file" accept="image/*" class="hidden">
            <input type="file" id="map-camera-file" accept="image/*" capture="environment" class="hidden">
            <div class="grid grid-cols-2 gap-3">
              <button id="upload-map-btn" class="bg-amber-600 hover:bg-amber-500 p-4 rounded-lg font-bold text-lg">
                Gallery
              </button>
              <button id="camera-map-btn" class="bg-indigo-600 hover:bg-indigo-500 p-4 rounded-lg font-bold text-lg">
                Camera
              </button>
            </div>
            <p class="text-gray-500 text-sm mt-2 text-center">Take a photo or upload from gallery</p>

            <!-- Preset Maps Section -->
            <div id="preset-maps-section" class="mt-6">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-sm font-bold text-gray-400">Or choose a preset map:</h4>
                <select id="preset-category-filter" class="bg-gray-700 text-sm px-2 py-1 rounded">
                  <option value="all">All Maps</option>
                  <option value="City">City Maps</option>
                  <option value="Region">Region Maps</option>
                </select>
              </div>
              <div id="preset-maps-grid" class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto">
                <!-- Populated by JavaScript -->
              </div>
              <p id="preset-maps-empty" class="text-gray-500 text-xs mt-2 text-center hidden">
                Run <code class="bg-gray-700 px-1 rounded">npm run download-maps</code> to download preset maps
              </p>
            </div>
          </div>

          <!-- Map Canvas Section (shown when image loaded) -->
          <div id="map-canvas-section" class="hidden">
            <!-- Map Canvas (maximized) -->
            <div id="map-viewport" class="relative bg-black rounded-lg mx-auto overflow-hidden">
              <div id="map-canvas-container" class="relative">
                <canvas id="map-canvas" class="absolute inset-0 w-full h-full"></canvas>
                <canvas id="figure-canvas" class="absolute inset-0 w-full h-full"></canvas>
                <canvas id="fog-canvas" class="absolute inset-0 w-full h-full"></canvas>
                <canvas id="preview-canvas" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
              </div>
              <!-- Vertical Zoom Slider (Overlay) -->
              <div
                class="absolute right-4 top-1/2 -translate-y-1/2 z-20 h-48 w-8 flex items-center justify-center pointer-events-auto">
                <input type="range" id="zoom-slider" min="1" max="3" step="0.1" value="1"
                  class="w-32 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                <!-- Tooltip floating to the left of the slider (since slider is rotated) -->
                <div id="zoom-tooltip"
                  class="absolute left-[-3rem] bg-gray-900 text-amber-500 font-bold text-xs px-2 py-1 rounded opacity-0 transition-opacity pointer-events-none whitespace-nowrap">
                  100%
                </div>
              </div>
            </div>

            <!-- Confirm/Cancel buttons (overlay on map when preview exists) -->
            <div id="preview-actions" class="hidden absolute safe-bottom-16 left-2 right-2 z-50 flex gap-2">
              <button id="cancel-preview-btn"
                class="flex-1 bg-gray-700/90 hover:bg-gray-600 p-3 rounded-lg font-bold shadow-lg backdrop-blur">
                Cancel
              </button>
              <button id="confirm-preview-btn"
                class="flex-1 bg-green-600/90 hover:bg-green-500 p-3 rounded-lg font-bold shadow-lg backdrop-blur">
                Confirm
              </button>
            </div>
          </div>

          <!-- Reveal Size Controls (S/M/L) - Floating above mode toggle -->
          <div id="reveal-size-controls"
            class="hidden fixed safe-bottom-20 left-4 z-40 flex rounded-lg overflow-hidden shadow-lg mb-2">
            <button id="size-s-btn"
              class="w-10 h-10 bg-gray-700 hover:bg-gray-600 font-bold text-sm border-r border-gray-600">S</button>
            <button id="size-m-btn"
              class="w-10 h-10 bg-gray-700 hover:bg-gray-600 font-bold text-sm border-r border-gray-600">M</button>
            <button id="size-l-btn" class="w-10 h-10 bg-gray-700 hover:bg-gray-600 font-bold text-sm">L</button>
          </div>

          <!-- Mode Toggle (overlay on map) -->
          <div id="mode-toggle"
            class="hidden fixed safe-bottom-4 left-4 z-40 flex rounded-lg overflow-hidden shadow-lg">
            <button id="mode-zoom-btn" class="px-4 py-3 bg-amber-600 font-bold text-sm active">Zoom</button>
            <button id="mode-figure-btn"
              class="px-4 py-3 bg-gray-700 font-bold text-sm border-l border-gray-500">ðŸŽ­</button>
            <button id="mode-draw-btn"
              class="px-4 py-3 bg-gray-700 font-bold text-sm border-l border-gray-500">Reveal</button>
          </div>

          <!-- Reset Zoom Button (floating above mode toggle, only visible when zoomed) -->
          <button id="reset-zoom-btn"
            class="hidden fixed z-40 px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold text-xs shadow-lg"
            style="left: 1rem; bottom: calc(4rem + env(safe-area-inset-bottom) + 3.5rem);">
            â†º Reset
          </button>

          <!-- Controls Toggle Button (overlay on map) -->
          <button id="settings-toggle-btn" title="Map Settings"
            class="hidden fixed safe-bottom-4 right-4 z-40 w-12 h-12 rounded-full bg-gray-700 shadow-lg flex items-center justify-center text-xl">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="w-6 h-6 text-gray-300">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </button>

          <!-- Floating Figure Palette -->
          <div id="figure-palette-floating" class="hidden fixed z-40"
            style="left: 1rem; top: 50%; transform: translateY(-50%);">
            <!-- Palette (shown when Figure mode active) -->
            <div id="figure-palette-expanded"
              class="bg-gray-800 rounded-lg shadow-xl p-2 min-w-max">
              <div class="flex flex-col gap-1">
                <!-- Enemies Row -->
                <div class="flex gap-1">
                  <button class="figure-btn-float" data-type="enemy" data-number="1">ðŸ”´1</button>
                  <button class="figure-btn-float" data-type="enemy" data-number="2">ðŸ”´2</button>
                  <button class="figure-btn-float" data-type="enemy" data-number="3">ðŸ”´3</button>
                  <button class="figure-btn-float" data-type="enemy" data-number="4">ðŸ”´4</button>
                  <button class="figure-btn-float" data-type="enemy" data-number="5">ðŸ”´5</button>
                </div>
                <!-- Players Row -->
                <div class="flex gap-1">
                  <button class="figure-btn-float" data-type="player" data-number="1">ðŸŸ¢1</button>
                  <button class="figure-btn-float" data-type="player" data-number="2">ðŸŸ¢2</button>
                  <button class="figure-btn-float" data-type="player" data-number="3">ðŸŸ¢3</button>
                  <button class="figure-btn-float" data-type="player" data-number="4">ðŸŸ¢4</button>
                  <button class="figure-btn-float" data-type="player" data-number="5">ðŸŸ¢5</button>
                </div>
                <!-- Special Row -->
                <div class="flex gap-1 justify-between">
                  <button class="figure-btn-float" data-type="poi">â˜…</button>
                  <button id="clear-figures-btn-float" class="text-xs text-red-400 hover:text-red-300 px-2">Clear
                    All</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Settings Modal (was controls-panel) -->
          <div id="settings-modal"
            class="hidden fixed safe-bottom-20 right-4 z-30 bg-gray-800 rounded-lg shadow-xl p-3 w-72">
            <!-- Map Controls -->
            <div class="flex gap-2 mb-3">
              <button id="change-map-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 p-2 rounded text-xs">
                Change
              </button>
              <button id="clear-fog-btn" class="flex-1 bg-red-700 hover:bg-red-600 p-2 rounded text-xs">
                Hide All
              </button>
              <button id="reveal-all-btn" class="flex-1 bg-green-700 hover:bg-green-600 p-2 rounded text-xs">
                Show All
              </button>
            </div>

            <!-- Preset Map Selector (collapsible) -->
            <details id="preset-selector-loaded" class="mb-3 bg-gray-700 rounded-lg">
              <summary class="p-2 cursor-pointer text-xs font-bold text-gray-300 hover:text-white">
                Preset Maps
              </summary>
              <div class="p-2 pt-0">
                <select id="preset-category-filter-loaded" class="w-full bg-gray-600 text-xs px-2 py-1 rounded mb-2">
                  <option value="all">All Maps</option>
                  <option value="City">City Maps</option>
                  <option value="Region">Region Maps</option>
                </select>
                <div id="preset-maps-grid-loaded" class="grid grid-cols-3 gap-1 max-h-24 overflow-y-auto">
                  <!-- Populated by JavaScript -->
                </div>
              </div>
            </details>



            <!-- Rotate Controls -->
            <div class="flex items-center justify-end gap-2 mb-3">
              <div class="flex items-center gap-1">
                <button id="rotate-left-btn" class="bg-gray-700 hover:bg-gray-600 w-8 h-8 rounded">â†º</button>
                <button id="rotate-right-btn" class="bg-gray-700 hover:bg-gray-600 w-8 h-8 rounded">â†»</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-panel hidden">
          <!-- Session Info -->
          <h3 class="font-bold mb-3">Session Info</h3>
          <div class="bg-gray-900 rounded-lg p-4 mb-4">
            <div class="text-center mb-4">
              <p class="text-gray-400 text-sm mb-1">Join Code</p>
              <div id="settings-join-code" class="text-4xl font-mono font-bold text-amber-400 tracking-widest"></div>
            </div>
            <div class="border-t border-gray-700 pt-4">
              <p class="text-gray-400 text-sm mb-2">Player Display Link</p>
              <div class="flex gap-2">
                <input type="text" id="table-link" readonly
                  class="flex-1 bg-gray-800 text-gray-300 p-2 rounded text-sm font-mono">
                <button id="copy-link-btn" class="bg-amber-600 hover:bg-amber-500 px-4 py-2 rounded text-sm font-bold">
                  Copy
                </button>
              </div>
              <p class="text-gray-500 text-xs mt-2">Share this link with the TV/monitor to display the game</p>
            </div>
          </div>

          <!-- Display Mode -->
          <h3 class="font-bold mb-3">Display Mode</h3>
          <div class="grid grid-cols-2 gap-2 mb-6">
            <button class="display-mode-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg"
              data-mode="blank">Blank</button>
            <button class="display-mode-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg" data-mode="map">Map</button>
          </div>

          <!-- End Session -->
          <button id="end-session-btn" class="w-full bg-red-700 hover:bg-red-600 p-3 rounded-lg">
            End Session
          </button>
        </div>
      </div>
    </div>

  </main>

  <!-- Tab Bar -->
  <nav class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700">
    <div class="flex">
      <button class="tab-btn flex-1 py-4 text-center text-sm font-medium text-amber-400" data-tab="map">
        Map
      </button>
      <button class="tab-btn flex-1 py-4 text-center text-sm font-medium text-gray-400" data-tab="settings">
        Settings
      </button>
    </div>
  </nav>

  <script src="/shared/ws-client.js?v=5"></script>
  <script type="module" src="/gm/gm.js?v=11"></script>
</body>

</html>