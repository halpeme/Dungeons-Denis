<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GM Controller - Dungeon & Denis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/gm/gm.css">
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <!-- Connection Status Bar -->
  <div id="status-bar" class="fixed top-0 left-0 right-0 bg-gray-800 p-2 flex justify-between items-center z-50">
    <span class="text-amber-400 font-bold">Dungeon & Denis</span>
    <div id="connection-status" class="flex items-center gap-2">
      <span class="w-2 h-2 rounded-full bg-red-500" id="status-dot"></span>
      <span id="status-text" class="text-sm">Disconnected</span>
    </div>
  </div>

  <!-- Main Content -->
  <main class="pt-12 pb-20">
    <!-- Session Panel (shown when no session) -->
    <div id="session-panel" class="p-4">
      <div class="max-w-md mx-auto text-center">
        <h1 class="text-2xl font-bold mb-6">Game Master</h1>

        <div id="create-session-panel">
          <button id="create-session-btn" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-4 px-8 rounded-lg text-xl transition-colors">
            Create New Session
          </button>

          <div class="mt-6 text-gray-400 text-sm">
            <p>Or reconnect to existing session:</p>
            <button id="reconnect-btn" class="mt-2 text-amber-400 underline">Reconnect</button>
          </div>
        </div>

        <div id="join-code-panel" class="hidden">
          <div class="bg-gray-800 rounded-lg p-4 mb-4">
            <p class="text-gray-400 text-sm mb-1">Join Code</p>
            <div id="join-code" class="text-5xl font-mono font-bold text-amber-400 tracking-widest mb-2"></div>
            <button id="copy-code-btn" class="text-sm text-amber-400 underline">Copy Code</button>
          </div>

          <div class="bg-gray-800 rounded-lg p-4 mb-4">
            <p class="text-gray-400 text-sm mb-2">Open this link on the TV/monitor:</p>
            <div class="flex gap-2">
              <input type="text" id="session-table-link" readonly class="flex-1 bg-gray-700 text-gray-300 p-2 rounded text-sm font-mono">
              <button id="copy-session-link-btn" class="bg-amber-600 hover:bg-amber-500 px-3 py-2 rounded text-sm font-bold">
                Copy
              </button>
            </div>
          </div>

          <div id="table-status" class="p-4 bg-gray-800 rounded-lg">
            <span class="text-gray-400">Table Display:</span>
            <span id="table-connected" class="ml-2 text-red-400">Not Connected</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Control Panel (shown when session active) -->
    <div id="control-panel" class="hidden p-4">
      <!-- Tab Content -->
      <div id="tab-content" class="bg-gray-800 rounded-lg p-4">
        <!-- Map Tab - Image-based Fog of War -->
        <div id="tab-map" class="tab-panel">
          <!-- Upload Section (shown when no image) -->
          <div id="map-upload-section">
            <h3 class="font-bold mb-3">Map Image</h3>
            <input type="file" id="map-image-file" accept="image/*" class="hidden">
            <input type="file" id="map-camera-file" accept="image/*" capture="environment" class="hidden">
            <div class="grid grid-cols-2 gap-3">
              <button id="upload-map-btn" class="bg-amber-600 hover:bg-amber-500 p-4 rounded-lg font-bold text-lg">
                Gallery
              </button>
              <button id="camera-map-btn" class="bg-indigo-600 hover:bg-indigo-500 p-4 rounded-lg font-bold text-lg">
                Camera
              </button>
            </div>
            <p class="text-gray-500 text-sm mt-2 text-center">Take a photo or upload from gallery</p>

            <!-- Preset Maps Section -->
            <div id="preset-maps-section" class="mt-6">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-sm font-bold text-gray-400">Or choose a preset map:</h4>
                <select id="preset-category-filter" class="bg-gray-700 text-sm px-2 py-1 rounded">
                  <option value="all">All Maps</option>
                  <option value="City">City Maps</option>
                  <option value="Region">Region Maps</option>
                </select>
              </div>
              <div id="preset-maps-grid" class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto">
                <!-- Populated by JavaScript -->
              </div>
              <p id="preset-maps-empty" class="text-gray-500 text-xs mt-2 text-center hidden">
                Run <code class="bg-gray-700 px-1 rounded">npm run download-maps</code> to download preset maps
              </p>
            </div>
          </div>

          <!-- Map Canvas Section (shown when image loaded) -->
          <div id="map-canvas-section" class="hidden">
            <!-- Controls -->
            <div class="flex gap-2 mb-3">
              <button id="change-map-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 p-2 rounded text-sm">
                Change Image
              </button>
              <button id="clear-fog-btn" class="flex-1 bg-red-700 hover:bg-red-600 p-2 rounded text-sm">
                Hide All
              </button>
              <button id="reveal-all-btn" class="flex-1 bg-green-700 hover:bg-green-600 p-2 rounded text-sm">
                Show All
              </button>
            </div>

            <!-- Preset Map Selector (collapsible) -->
            <details id="preset-selector-loaded" class="mb-3 bg-gray-700 rounded-lg">
              <summary class="p-2 cursor-pointer text-sm font-bold text-gray-300 hover:text-white">
                Load Preset Map
              </summary>
              <div class="p-2 pt-0">
                <select id="preset-category-filter-loaded" class="w-full bg-gray-600 text-sm px-2 py-1 rounded mb-2">
                  <option value="all">All Maps</option>
                  <option value="City">City Maps</option>
                  <option value="Region">Region Maps</option>
                </select>
                <div id="preset-maps-grid-loaded" class="grid grid-cols-3 gap-1 max-h-32 overflow-y-auto">
                  <!-- Populated by JavaScript -->
                </div>
              </div>
            </details>

            <!-- Figure Palette -->
            <div class="mb-3">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-bold">Figures</span>
                <button id="clear-figures-btn" class="text-xs text-red-400 hover:text-red-300">Clear All</button>
              </div>
              <div id="figure-palette" class="flex gap-2 flex-wrap">
                <!-- Red enemies 1-5 -->
                <button class="figure-btn" data-type="enemy" data-number="1">üî¥1</button>
                <button class="figure-btn" data-type="enemy" data-number="2">üî¥2</button>
                <button class="figure-btn" data-type="enemy" data-number="3">üî¥3</button>
                <button class="figure-btn" data-type="enemy" data-number="4">üî¥4</button>
                <button class="figure-btn" data-type="enemy" data-number="5">üî¥5</button>
                <!-- Green players 1-5 -->
                <button class="figure-btn" data-type="player" data-number="1">üü¢1</button>
                <button class="figure-btn" data-type="player" data-number="2">üü¢2</button>
                <button class="figure-btn" data-type="player" data-number="3">üü¢3</button>
                <button class="figure-btn" data-type="player" data-number="4">üü¢4</button>
                <button class="figure-btn" data-type="player" data-number="5">üü¢5</button>
                <!-- POI -->
                <button class="figure-btn" data-type="poi">‚òÖ</button>
              </div>
            </div>

            <!-- Map Canvas (touch to reveal/hide) -->
            <div id="map-viewport" class="relative bg-black rounded-lg mx-auto overflow-hidden">
              <div id="map-canvas-container" class="relative">
                <canvas id="map-canvas" class="absolute inset-0 w-full h-full"></canvas>
                <canvas id="figure-canvas" class="absolute inset-0 w-full h-full"></canvas>
                <canvas id="fog-canvas" class="absolute inset-0 w-full h-full"></canvas>
                <canvas id="preview-canvas" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
              </div>
            </div>

            <!-- Zoom & Rotate Controls -->
            <div id="zoom-rotate-controls" class="mt-2 flex flex-wrap items-center justify-between gap-2">
              <div class="flex items-center gap-1">
                <span class="text-xs text-gray-400 mr-1">Zoom:</span>
                <button id="zoom-out-btn" class="bg-gray-700 hover:bg-gray-600 active:bg-gray-500 w-10 h-10 rounded text-lg font-bold">‚àí</button>
                <span id="zoom-level" class="text-xs text-gray-300 w-12 text-center">100%</span>
                <button id="zoom-in-btn" class="bg-gray-700 hover:bg-gray-600 active:bg-gray-500 w-10 h-10 rounded text-lg font-bold">+</button>
                <button id="zoom-reset-btn" class="bg-gray-700 hover:bg-gray-600 active:bg-gray-500 px-3 h-10 rounded text-xs">Reset</button>
                <button id="draw-mode-btn" class="hidden bg-gray-700 hover:bg-gray-600 active:bg-gray-500 px-3 h-10 rounded text-xs ml-2">Draw Mode</button>
              </div>
              <div class="flex items-center gap-1">
                <span class="text-xs text-gray-400 mr-1">Rotate:</span>
                <button id="rotate-left-btn" class="bg-gray-700 hover:bg-gray-600 active:bg-gray-500 w-10 h-10 rounded text-lg">‚Ü∫</button>
                <button id="rotate-right-btn" class="bg-gray-700 hover:bg-gray-600 active:bg-gray-500 w-10 h-10 rounded text-lg">‚Üª</button>
              </div>
            </div>
            <p class="text-gray-500 text-xs mt-1 sm:hidden">Scroll to zoom, drag to pan when zoomed</p>

            <!-- Confirm/Cancel buttons (shown when preview exists) -->
            <div id="preview-actions" class="hidden mt-3 flex gap-2">
              <button id="cancel-preview-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 p-3 rounded-lg font-bold">
                Cancel
              </button>
              <button id="confirm-preview-btn" class="flex-1 bg-green-600 hover:bg-green-500 p-3 rounded-lg font-bold">
                Confirm Reveal
              </button>
            </div>

            <!-- Brush Controls -->
            <div class="mt-3 flex items-center gap-4">
              <span class="text-sm text-gray-400">Brush:</span>
              <div class="flex gap-1">
                <button class="brush-size-btn bg-gray-700 hover:bg-gray-600 w-8 h-8 rounded text-xs" data-size="20">S</button>
                <button class="brush-size-btn bg-amber-600 w-8 h-8 rounded text-xs" data-size="40">M</button>
                <button class="brush-size-btn bg-gray-700 hover:bg-gray-600 w-8 h-8 rounded text-xs" data-size="80">L</button>
              </div>
              <span class="text-sm text-gray-400 ml-4">Mode:</span>
              <div class="flex gap-1">
                <button id="mode-reveal-btn" class="bg-green-600 px-3 py-1 rounded text-sm">Reveal</button>
                <button id="mode-hide-btn" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">Hide</button>
              </div>
            </div>
            <p class="text-gray-500 text-xs mt-2">Draw on the map to reveal or hide areas</p>
          </div>
        </div>

        <!-- Handouts Tab -->
        <div id="tab-handouts" class="tab-panel hidden">
          <h3 class="font-bold mb-3">Handouts</h3>
          <div class="space-y-2">
            <input type="file" id="handout-file" accept="image/*" class="hidden">
            <button id="upload-handout-btn" class="w-full bg-gray-700 hover:bg-gray-600 p-3 rounded-lg">
              Upload Image
            </button>
            <input type="text" id="handout-url" placeholder="Or paste image URL" class="w-full bg-gray-700 p-3 rounded-lg">
            <button id="push-handout-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 p-3 rounded-lg font-bold">
              Push to Table
            </button>
            <button id="clear-handout-btn" class="w-full bg-red-700 hover:bg-red-600 p-3 rounded-lg">
              Clear Handout
            </button>
          </div>
        </div>

        <!-- Decisions Tab -->
        <div id="tab-decisions" class="tab-panel hidden">
          <h3 class="font-bold mb-3">Decision Point</h3>
          <input type="text" id="decision-title" placeholder="Title (e.g., 'Which path?')" class="w-full bg-gray-700 p-3 rounded-lg mb-2">
          <div id="decision-options" class="space-y-2 mb-2">
            <input type="text" placeholder="Option 1" class="decision-option w-full bg-gray-700 p-2 rounded">
            <input type="text" placeholder="Option 2" class="decision-option w-full bg-gray-700 p-2 rounded">
          </div>
          <button id="add-option-btn" class="text-sm text-gray-400 mb-3">+ Add option</button>
          <button id="push-decision-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 p-3 rounded-lg font-bold">
            Push Decision
          </button>
          <button id="clear-decision-btn" class="w-full bg-red-700 hover:bg-red-600 p-3 rounded-lg mt-2">
            Clear Decision
          </button>
        </div>

        <!-- Puzzles Tab -->
        <div id="tab-puzzles" class="tab-panel hidden">
          <h3 class="font-bold mb-3">Puzzles</h3>
          <select id="puzzle-type" class="w-full bg-gray-700 p-3 rounded-lg mb-3">
            <option value="choice">Multiple Choice</option>
            <option value="riddle">Text Riddle</option>
            <option value="sequence">Sequence Puzzle</option>
            <option value="lockedDoor">Locked Door (Symbols)</option>
          </select>

          <!-- Choice puzzle form -->
          <div id="puzzle-choice-form" class="space-y-2">
            <input type="text" id="choice-question" placeholder="Question" class="w-full bg-gray-700 p-2 rounded">
            <input type="text" id="choice-opt1" placeholder="Option 1" class="w-full bg-gray-700 p-2 rounded">
            <input type="text" id="choice-opt2" placeholder="Option 2" class="w-full bg-gray-700 p-2 rounded">
            <input type="text" id="choice-opt3" placeholder="Option 3" class="w-full bg-gray-700 p-2 rounded">
            <input type="text" id="choice-answer" placeholder="Correct option (1, 2, or 3)" class="w-full bg-gray-700 p-2 rounded">
          </div>

          <!-- Riddle puzzle form -->
          <div id="puzzle-riddle-form" class="space-y-2 hidden">
            <textarea id="riddle-question" placeholder="Riddle text" class="w-full bg-gray-700 p-2 rounded h-24"></textarea>
            <input type="text" id="riddle-answer" placeholder="Answer" class="w-full bg-gray-700 p-2 rounded">
            <input type="text" id="riddle-hint" placeholder="Hint (optional)" class="w-full bg-gray-700 p-2 rounded">
          </div>

          <!-- Sequence puzzle form -->
          <div id="puzzle-sequence-form" class="space-y-2 hidden">
            <input type="text" id="sequence-instruction" placeholder="Instruction" class="w-full bg-gray-700 p-2 rounded">
            <textarea id="sequence-items" placeholder="Items (one per line)" class="w-full bg-gray-700 p-2 rounded h-24"></textarea>
            <input type="text" id="sequence-order" placeholder="Correct order (e.g., 3,1,4,2)" class="w-full bg-gray-700 p-2 rounded">
          </div>

          <!-- Locked Door puzzle form -->
          <div id="puzzle-lockedDoor-form" class="space-y-2 hidden">
            <input type="text" id="door-title" placeholder="Door name (e.g., Ancient Gate)" class="w-full bg-gray-700 p-2 rounded">
            <p class="text-sm text-gray-400">Select symbols to use:</p>
            <div id="door-symbols-select" class="grid grid-cols-6 gap-2 mb-2">
              <button type="button" class="symbol-toggle p-2 text-2xl bg-gray-700 rounded hover:bg-gray-600" data-symbol="sun">‚òÄ</button>
              <button type="button" class="symbol-toggle p-2 text-2xl bg-gray-700 rounded hover:bg-gray-600" data-symbol="moon">‚òΩ</button>
              <button type="button" class="symbol-toggle p-2 text-2xl bg-gray-700 rounded hover:bg-gray-600" data-symbol="star">‚òÖ</button>
              <button type="button" class="symbol-toggle p-2 text-2xl bg-gray-700 rounded hover:bg-gray-600" data-symbol="fire">üî•</button>
              <button type="button" class="symbol-toggle p-2 text-2xl bg-gray-700 rounded hover:bg-gray-600" data-symbol="water">üíß</button>
              <button type="button" class="symbol-toggle p-2 text-2xl bg-gray-700 rounded hover:bg-gray-600" data-symbol="skull">üíÄ</button>
              <button type="button" class="symbol-toggle p-2 text-2xl bg-gray-700 rounded hover:bg-gray-600" data-symbol="key">üóù</button>
              <button type="button" class="symbol-toggle p-2 text-2xl bg-gray-700 rounded hover:bg-gray-600" data-symbol="eye">üëÅ</button>
              <button type="button" class="symbol-toggle p-2 text-2xl bg-gray-700 rounded hover:bg-gray-600" data-symbol="snake">üêç</button>
              <button type="button" class="symbol-toggle p-2 text-2xl bg-gray-700 rounded hover:bg-gray-600" data-symbol="crown">üëë</button>
              <button type="button" class="symbol-toggle p-2 text-2xl bg-gray-700 rounded hover:bg-gray-600" data-symbol="sword">‚öî</button>
              <button type="button" class="symbol-toggle p-2 text-2xl bg-gray-700 rounded hover:bg-gray-600" data-symbol="shield">üõ°</button>
            </div>
            <p class="text-sm text-gray-400">Correct sequence (click symbols in order):</p>
            <div id="door-sequence-display" class="flex gap-2 min-h-12 bg-gray-800 p-2 rounded items-center">
              <span class="text-gray-500">Click symbols above...</span>
            </div>
            <button type="button" id="clear-door-sequence" class="text-sm text-red-400">Clear sequence</button>
          </div>

          <button id="push-puzzle-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 p-3 rounded-lg font-bold mt-3">
            Push Puzzle
          </button>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-panel hidden">
          <!-- Session Info -->
          <h3 class="font-bold mb-3">Session Info</h3>
          <div class="bg-gray-900 rounded-lg p-4 mb-4">
            <div class="text-center mb-4">
              <p class="text-gray-400 text-sm mb-1">Join Code</p>
              <div id="settings-join-code" class="text-4xl font-mono font-bold text-amber-400 tracking-widest"></div>
            </div>
            <div class="border-t border-gray-700 pt-4">
              <p class="text-gray-400 text-sm mb-2">Player Display Link</p>
              <div class="flex gap-2">
                <input type="text" id="table-link" readonly class="flex-1 bg-gray-800 text-gray-300 p-2 rounded text-sm font-mono">
                <button id="copy-link-btn" class="bg-amber-600 hover:bg-amber-500 px-4 py-2 rounded text-sm font-bold">
                  Copy
                </button>
              </div>
              <p class="text-gray-500 text-xs mt-2">Share this link with the TV/monitor to display the game</p>
            </div>
          </div>

          <!-- Display Mode -->
          <h3 class="font-bold mb-3">Display Mode</h3>
          <div class="grid grid-cols-2 gap-2 mb-6">
            <button class="display-mode-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg" data-mode="blank">Blank</button>
            <button class="display-mode-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg" data-mode="map">Map</button>
          </div>

          <!-- End Session -->
          <button id="end-session-btn" class="w-full bg-red-700 hover:bg-red-600 p-3 rounded-lg">
            End Session
          </button>
        </div>
      </div>
    </div>

  </main>

  <!-- Tab Bar -->
  <nav class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700">
    <div class="flex">
      <button class="tab-btn flex-1 py-4 text-center text-sm font-medium text-amber-400" data-tab="map">
        Map
      </button>
      <button class="tab-btn flex-1 py-4 text-center text-sm font-medium text-gray-400" data-tab="handouts">
        Handouts
      </button>
      <button class="tab-btn flex-1 py-4 text-center text-sm font-medium text-gray-400" data-tab="decisions">
        Decisions
      </button>
      <button class="tab-btn flex-1 py-4 text-center text-sm font-medium text-gray-400" data-tab="puzzles">
        Puzzles
      </button>
      <button class="tab-btn flex-1 py-4 text-center text-sm font-medium text-gray-400" data-tab="settings">
        Settings
      </button>
    </div>
  </nav>

  <script src="/shared/ws-client.js"></script>
  <script src="/gm/gm.js"></script>
</body>
</html>
